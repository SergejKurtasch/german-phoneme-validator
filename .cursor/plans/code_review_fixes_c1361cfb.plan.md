---
name: Code Review Fixes
overview: План исправления ошибок, несоответствий и неоптимальностей, найденных при код-ревью проекта german-phoneme-validator
todos:
  - id: fix-warnings
    content: Исправить глобальное подавление warnings в feature_extraction.py - использовать локальное подавление или context manager
    status: completed
  - id: extract-constants
    content: Вынести магические числа в константы (pre-emphasis 0.97, частоты 50-500Hz, 2000-8000Hz, threshold 0.7)
    status: completed
  - id: replace-assert
    content: Заменить assert на ValueError в models.py forward() для production кода
    status: completed
  - id: fix-global-validator
    content: Исправить потокобезопасность глобальной переменной _validator в validator.py
    status: completed
  - id: improve-exceptions
    content: Улучшить обработку исключений - использовать специфичные типы вместо broad Exception
    status: completed
  - id: add-validation
    content: Добавить валидацию входных данных в feature_extraction.py (проверка пустых массивов)
    status: completed
  - id: remove-duplication
    content: Устранить дублирование кода - вынести normalize_filter_frequencies и normalize_feature_vector
    status: completed
  - id: split-long-functions
    content: Разбить длинные функции detect_voicing_onset и extract_all_features на более мелкие
    status: completed
---

# План исправлений по результатам код-ревью

## Обзор найденных проблем

При анализе кода обнаружены проблемы в следующих категориях:

1. **Управление предупреждениями и исключениями** - глобальное подавление warnings, слишком широкие except
2. **Константы и магические числа** - невынесенные числовые значения
3. **Валидация входных данных** - недостаточные проверки
4. **Дублирование кода** - повторяющиеся паттерны
5. **Потокобезопасность** - глобальные переменные
6. **Производственный код** - assert в runtime вместо ValueError

---

## Детальный анализ по файлам

### 1. `core/feature_extraction.py`

**Проблемы:**

1. **Глобальное подавление warnings (строка 11)**

- `warnings.filterwarnings('ignore')` на уровне модуля скрывает важные предупреждения
- **Исправление:** Подавлять локально в функциях или использовать context manager

2. **Магические числа без констант**

- `0.97` (pre-emphasis в `extract_formants_lpc`)
- `50-500 Hz` (low-frequency в нескольких функциях)
- `2000-8000 Hz` (high-frequency для burst detection)
- `0.7` (magnitude threshold)
- **Исправление:** Вынести в константы с пояснениями

3. **Слишком широкие исключения**

- `except Exception:` в `detect_burst`, `detect_voicing_onset`, `extract_vot`, `apply_vad`
- Скрывает реальные ошибки
- **Исправление:** Ловить специфичные исключения или логировать traceback

4. **Дублирование кода нормализации частот фильтра**

- Повторяется в `detect_burst`, `detect_voicing_onset`, `extract_low_frequency_energy`
- **Исправление:** Вынести в функцию `_normalize_filter_frequencies(low_freq, high_freq, nyquist)`

5. **Длинные функции**

- `detect_voicing_onset` (80+ строк) - нарушает правило <50 строк
- `extract_all_features` можно упростить
- **Исправление:** Разбить на более мелкие функции

6. **Отсутствие валидации входных данных**

- Нет проверки на пустые массивы в `extract_mfcc_features`
- **Исправление:** Добавить проверки в начало функций

---

### 2. `core/models.py`

**Проблемы:**

1. **Assert в forward() (строки 261-264)**

- `assert` отключаются в optimized Python (`-O`)
- В production коде лучше использовать ValueError
- **Исправление:** Заменить на проверки с ValueError

2. **Хардкод размеров в комментариях (строка 181)**

- `# (64, 64, 3)` может не соответствовать реальным размерам
- **Исправление:** Использовать динамические вычисления или убрать неточные комментарии

---

### 3. `core/validator.py`

**Проблемы:**

1. **Глобальная переменная `_validator` (строка 784)**

- Потенциальная проблема в многопоточности
- Нет механизма обновления/сброса
- **Исправление:** Использовать thread-local storage или убрать глобальную переменную

2. **Дублирование проверок размеров массивов (строки 454-467)**

- Логика проверки/обрезки/падинга повторяется
- **Исправление:** Вынести в функцию `_normalize_feature_vector(vector, expected_size)`

3. **Слишком широкие исключения (строки 272, 520, 771)**

- `except Exception as e:` скрывает детали ошибок
- **Исправление:** Ловить специфичные исключения, логировать traceback для остальных

4. **Дублирование логики загрузки audio (строки 660-686)**

- Похожий код в `validate_phoneme` и `extract_all_features` из `feature_extraction.py`
- **Исправление:** Использовать общую функцию

5. **Проверка `if 'speech_frames' in locals()` (строка 625)**

- Неявная зависимость от порядка выполнения
- **Исправление:** Явно инициализировать переменные

---

### 4. `example_usage.py`

**Проблемы:**

1. **Множественные try-except для импорта (строки 25-37)**

- Можно упростить
- **Исправление:** Использовать единый паттерн импорта

---

### 5. `setup.py` и `requirements.txt`

**Проблемы:**

1. **Комментарии в requirements.txt**

- Комментарии удаляются при парсинге, но структура хорошая
- **Исправление:** Комментарии оставить, структура приемлема

2. **Фильтрация опциональных зависимостей (setup.py строка 33)**

- Хрупкая проверка через строковый поиск
- **Исправление:** Использовать секции или метки в requirements.txt

---

## Приоритеты исправлений

### Высокий приоритет (критические):

1. Заменить `assert` на `ValueError` в `models.py` forward()
2. Исправить глобальную переменную `_validator` для потокобезопасности
3. Добавить валидацию входных данных в `feature_extraction.py`

### Средний приоритет (важные):

4. Вынести магические числа в константы
5. Улучшить обработку исключений (специфичные типы)
6. Убрать глобальное `warnings.filterwarnings('ignore')`

### Низкий приоритет (улучшения):

7. Устранить дублирование кода (нормализация частот, проверка размеров)
8. Разбить длинные функции
9. Упростить импорты в `example_usage.py`

---

## Файлы для изменения

1. `core/feature_extraction.py` - основная часть исправлений
2. `core/models.py` - замена assert на ValueError
3. `core/validator.py` - потокобезопасность, дублирование, исключения
4. `example_usage.py` - упрощение импортов (опционально)

---

## Оценка объема

- Изменения затрагивают ~3-4 файла
- Около 15-20 локальных изменений
- Большинство изменений - рефакторинг без изменения логики
- Необходимо протестировать после изменений